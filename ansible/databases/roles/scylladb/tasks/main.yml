---
- name: Install Docker prerequisites
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - python3-pip
    state: present
    update_cache: yes

- name: Add Docker GPG key
  apt_key:
    url: https://download.docker.com/linux/debian/gpg
    state: present

- name: Add Docker repository
  apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
    state: present
    filename: docker

- name: Install Docker
  apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
    state: present
    update_cache: yes

- name: Start and enable Docker
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Install Python Docker packages
  apt:
    name:
      - python3-docker
      - python3-dockerpty
    state: present


- name: Create ScyllaDB data directory
  file:
    path: /var/lib/scylla-docker
    state: directory
    mode: '0755'

- name: Run ScyllaDB container
  docker_container:
    name: scylla
    image: scylladb/scylla:5.2
    state: started
    restart_policy: unless-stopped
    network_mode: host
    volumes:
      - /var/lib/scylla-docker:/var/lib/scylla
    command: >
      --seeds={{ scylla_seeds }}
      --listen-address={{ scylla_listen_address }}
      --rpc-address={{ scylla_rpc_address }}
      --broadcast-rpc-address={{ scylla_broadcast_rpc_address }}
      --authenticator={{ scylla_authenticator }}
      --authorizer={{ scylla_authorizer }}

- name: Wait for ScyllaDB to be ready
  wait_for:
    port: 9042
    host: "{{ scylla_listen_address }}"
    delay: 20
    timeout: 300

- name: Wait additional time for cluster to stabilize
  pause:
    seconds: 45

- name: Install cqlsh
  pip:
    name: cqlsh
    state: present
    executable: pip3
    extra_args: --break-system-packages

- name: Check if password already changed
  shell: |
    cqlsh {{ scylla_listen_address }} -u cassandra -p '{{ scylla_superuser_password }}' -e "DESCRIBE KEYSPACES;" 2>&1
  register: password_check
  ignore_errors: yes
  no_log: true
  changed_when: false

- name: Change default cassandra superuser password
  shell: |
    cqlsh {{ scylla_listen_address }} -u cassandra -p cassandra -e "ALTER USER cassandra WITH PASSWORD '{{ scylla_superuser_password }}';"
  when: password_check.rc != 0
  ignore_errors: yes
  no_log: true

- name: Wait after password change
  pause:
    seconds: 10
  when: password_check.rc != 0

- name: Create keyspaces
  shell: |
    cqlsh {{ scylla_listen_address }} -u cassandra -p '{{ scylla_superuser_password }}' -e "CREATE KEYSPACE IF NOT EXISTS {{ item.name }} WITH replication = {'class': 'SimpleStrategy', 'replication_factor': {{ item.replication_factor }}};"
  loop: "{{ keyspaces }}"
  no_log: true

- name: Create users for keyspaces
  shell: |
    cqlsh {{ scylla_listen_address }} -u cassandra -p '{{ scylla_superuser_password }}' -e "CREATE ROLE IF NOT EXISTS {{ item.key }} WITH PASSWORD = '{{ item.value }}' AND LOGIN = true;"
  loop: "{{ scylla_users | dict2items }}"
  no_log: true

- name: Grant permissions to users
  shell: |
    {% if 'dev' in item.name %}
    cqlsh {{ scylla_listen_address }} -u cassandra -p '{{ scylla_superuser_password }}' -e "GRANT ALL PERMISSIONS ON KEYSPACE {{ item.name }} TO {{ item.name | replace('_dev', '') }}_user_dev;"
    {% else %}
    cqlsh {{ scylla_listen_address }} -u cassandra -p '{{ scylla_superuser_password }}' -e "GRANT ALL PERMISSIONS ON KEYSPACE {{ item.name }} TO {{ item.name }}_user;"
    {% endif %}
  loop: "{{ keyspaces }}"
  no_log: true

- name: Display connection info
  debug:
    msg: |
      üöÄ ScyllaDB install√© et configur√© via Docker !
      
      Container: scylla
      Cluster: {{ scylla_cluster_name }}
      Host: {{ scylla_listen_address }}
      CQL Port: 9042
      
      Keyspaces cr√©√©s:
      {% for ks in keyspaces %}
      - {{ ks.name }} (RF: {{ ks.replication_factor }})
        User: {{ ks.name }}_user
        Connection: cqlsh {{ scylla_listen_address }} -u {{ ks.name }}_user -p [password]
      {% endfor %}
      
      Commandes utiles:
      - Voir les logs: docker logs scylla
      - Acc√©der au container: docker exec -it scylla bash
      - Red√©marrer: docker restart scylla